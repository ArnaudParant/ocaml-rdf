<!DOCTYPE HTML>
<html>
<head>
<title>OCaml-RDF : Executing Sparql queries</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="http://zoggy.github.io/ocaml-rdf/style.css" rel="stylesheet" type="text/css"/>
<rssfeed></rssfeed>
</head><body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">

  <div class="nav-collapse">
  <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="http://zoggy.github.io/ocaml-rdf">OCaml-RDF</a></li>
    <li class="&lt;navbar-download/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/download.html">Download</a></li>
    <li class="active"><a href="http://zoggy.github.io/ocaml-rdf/doc.html">Documentation</a></li>
    <li class="&lt;navbar-blog/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/about.html">?</a></li>
  </ul>
  </div>
  <div class="nav pull-right">

  </div>
</div>
</div>
</div>

<div id="header">

<div class="page-title">Executing Sparql queries</div>
</div>
<span></span>



<p id="OCamlRDFimplementsSparql"><a class="paragraph-url" href="#OCamlRDFimplementsSparql"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
OCaml-RDF implements <span class="ext-a"><a href="http://www.w3.org/TR/sparql11-query/">Sparql 1.1 Query</a></span>.
<a href="http://zoggy.github.io/ocaml-rdf/doc-todo.html#limitations">Some features are missing</a> but it's already quite complete.
The main module of the implementation is 
<a href="http://zoggy.github.io/ocaml-rdf/refdoc/Rdf_sparql.html">Rdf_sparql</a>
. We consider
this module open in the examples below:
</p>
<pre class="code-ocaml" id="openRdf_sparql"><a class="paragraph-url" href="#openRdf_sparql"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div><span class="hl kwa">open</span> <span class="hl kwd">Rdf_sparql</span><span class="hl opt">;;</span></div></pre>
<ul class="toc"><li class="toc-section"><a href="http://zoggy.github.io/ocaml-rdf/doc-sparql.html#parsing">Parsing and printing queries</a></li><li class="toc-section"><a href="http://zoggy.github.io/ocaml-rdf/doc-sparql.html#dataset">Datasets</a></li><li class="toc-section"><a href="http://zoggy.github.io/ocaml-rdf/doc-sparql.html#execution">Executing a query</a></li><li class="toc-section"><a href="http://zoggy.github.io/ocaml-rdf/doc-sparql.html#construct">CONSTRUCT queries</a></li></ul>
<div class="section"><div class="section-title" id="parsing">Parsing and printing queries</div>
<p id="TheexamplebelowparsesaSp"><a class="paragraph-url" href="#TheexamplebelowparsesaSp"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
The example below parses a Sparql query, then prints it:
</p>
<pre class="code-ocaml" id="letquerytryquery_from_st"><a class="paragraph-url" href="#letquerytryquery_from_st"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div><span class="hl kwa">let</span> query <span class="hl opt">=</span>
  <span class="hl kwa">try</span> query_from_string
    <span class="hl str">&quot;PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;</span>
<span class="hl str">     SELECT ?name ?mbox ?hpage</span>
<span class="hl str">     WHERE  { ?x foaf:name  ?name .</span>
<span class="hl str">         OPTIONAL { ?x foaf:mbox ?mbox } .</span>
<span class="hl str">         OPTIONAL { ?x foaf:homepage ?hpage }</span>
<span class="hl str">       }&quot;</span>
  <span class="hl kwa">with</span> <span class="hl kwd">Error</span> e <span class="hl opt">-&gt;</span> failwith <span class="hl opt">(</span>string_of_error e<span class="hl opt">)</span>
<span class="hl opt">;;</span></div><div>print_endline <span class="hl opt">(</span>string_of_query query<span class="hl opt">);;</span></div></pre>
</div>

<div class="section"><div class="section-title" id="dataset">Datasets</div>
<p id="ASparqlqueryisexecutedon"><a class="paragraph-url" href="#ASparqlqueryisexecutedon"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
A Sparql query is executed on a
<span class="ext-a"><a href="http://www.w3.org/TR/sparql11-query/#rdfDataset"><em>dataset</em></a></span>,
which is composed of a default (unnamed) graph, and other (named) graphs each associated
to an IRI.
</p>
<p id="TheRdf_dsdatasettyperepr"><a class="paragraph-url" href="#TheRdf_dsdatasettyperepr"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>The 
<a href="http://zoggy.github.io/ocaml-rdf/refdoc/Rdf_ds.html#TYPEdataset">Rdf_ds.dataset</a>
 type represents a dataset and contains
a default graph (which can be empty), a set of graph names (i.e. a set of IRIs), and
a function to get a graph by its IRI.
</p>
<p id="Theexamplebelowloadsagra"><a class="paragraph-url" href="#Theexamplebelowloadsagra"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>The example below loads a graph from the file <code>optional.ttl</code> then
creates a dataset with this graph as default graph, and no named graphs:
</p>
<pre class="code-ocaml" id="letbaseRdf_iriirihttpfoo"><a class="paragraph-url" href="#letbaseRdf_iriirihttpfoo"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div><span class="hl kwa">let</span> base <span class="hl opt">=</span> <span class="hl kwc">Rdf_iri</span><span class="hl opt">.</span>iri <span class="hl str">&quot;http://foo.net&quot;</span><span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> g <span class="hl opt">=</span> <span class="hl kwc">Rdf_graph</span><span class="hl opt">.</span>open_graph base <span class="hl opt">;;</span></div><div><span class="hl kwc">Rdf_ttl</span><span class="hl opt">.</span>from_file g <span class="hl str">&quot;optional.ttl&quot;</span><span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> dataset <span class="hl opt">=</span> <span class="hl kwc">Rdf_ds</span><span class="hl opt">.</span>simple_dataset g <span class="hl opt">;;</span></div></pre>
<p id="Hereisthecontentofourgra"><a class="paragraph-url" href="#Hereisthecontentofourgra"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>Here is the content of our graph:</p>

<pre class="code-ocaml" id="prefixfoafhttpxmlnscomfo"><a class="paragraph-url" href="#prefixfoafhttpxmlnscomfo"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div class="ocaml-toplevel"></div><div class="ocaml-toplevel">@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
_:genid1-308606191 foaf:name &quot;Bob&quot; .
_:genid1-308606191 foaf:mbox &lt;mailto:bob@work.example&gt; .
_:genid0-26462265 foaf:name &quot;Alice&quot; .
_:genid0-26462265 foaf:homepage &lt;http://work.example.org/alice/&gt; .
</div></pre>

</div>

<div class="section"><div class="section-title" id="execution">Executing a query</div>
<p id="Thefollowingcodeexecutes"><a class="paragraph-url" href="#Thefollowingcodeexecutes"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
The following code executes the query parsed above, on the dataset
defined in previous section. Since this is a SELECT query, the

<a href="http://zoggy.github.io/ocaml-rdf/refdoc/Rdf_sparql.html#VALexecute">Rdf_sparql.execute</a>
  function returns a <code>Solutions</code>
constructor with the sequence of solutions.
</p>
<pre class="code-ocaml" id="letresexecutebasedataset"><a class="paragraph-url" href="#letresexecutebasedataset"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div># <span class="hl kwa">let</span> res <span class="hl opt">=</span> execute ~base dataset query<span class="hl opt">;;</span></div><div class="ocaml-toplevel">val res : Rdf_sparql.query_result = Solutions [&lt;abstr&gt;; &lt;abstr&gt;]</div></pre>
<p id="Sinceweknowthatourqueryi"><a class="paragraph-url" href="#Sinceweknowthatourqueryi"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
Since we know that our query is a SELECT, we can use a convenient function
which will ensure that the query is a SELECT and return directly the sequence
of solutions:
</p>
<pre class="code-ocaml" id="letsolutionsselectbaseda"><a class="paragraph-url" href="#letsolutionsselectbaseda"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div># <span class="hl kwa">let</span> solutions <span class="hl opt">=</span> select ~base dataset query <span class="hl opt">;;</span></div><div class="ocaml-toplevel">val solutions : Rdf_sparql.solution list = [&lt;abstr&gt;; &lt;abstr&gt;]</div></pre>
<p id="LetsdisplaytheresultAsol"><a class="paragraph-url" href="#LetsdisplaytheresultAsol"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
Let's display the result. A solution, of type 
<a href="http://zoggy.github.io/ocaml-rdf/refdoc/Rdf_sparql.html#TYPEsolution">Rdf_sparql.solution</a>
,
is a map from variable name (string) to 
<a href="http://zoggy.github.io/ocaml-rdf/refdoc/Rdf_term.html#TYPEterm">Rdf_term.term</a>
.
Let's print the solutions we obtained.
</p>
<pre class="code-ocaml" id="letprint_solletprintvarn"><a class="paragraph-url" href="#letprint_solletprintvarn"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div># <span class="hl kwa">let</span> print_sol <span class="hl opt">=</span>
  <span class="hl kwa">let</span> print varname term <span class="hl opt">=</span>
     <span class="hl kwc">Printf</span><span class="hl opt">.</span>printf <span class="hl str">&quot;%s =&gt; %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> varname <span class="hl opt">(</span><span class="hl kwc">Rdf_term</span><span class="hl opt">.</span>string_of_term term<span class="hl opt">)</span>
  <span class="hl kwa">in</span>
  <span class="hl kwa">fun</span> sol <span class="hl opt">-&gt;</span>
    print_endline <span class="hl str">&quot;Solution:&quot;</span><span class="hl opt">;</span>
    solution_iter print sol <span class="hl opt">;</span>
    print_newline<span class="hl opt">();;</span></div><div class="ocaml-toplevel">val print_sol : Rdf_sparql.solution -&gt; unit = &lt;fun&gt;</div><div># <span class="hl kwc">List</span><span class="hl opt">.</span>iter print_sol solutions<span class="hl opt">;;</span></div><div class="ocaml-toplevel">Solution:
hpage =&gt; &lt;http://work.example.org/alice/&gt;
name =&gt; &quot;Alice&quot;

Solution:
mbox =&gt; &lt;mailto:bob@work.example&gt;
name =&gt; &quot;Bob&quot;

- : unit = ()</div></pre>
</div>

<div class="section"><div class="section-title" id="construct">CONSTRUCT queries</div>
<p id="Insteadofreturningaseque"><a class="paragraph-url" href="#Insteadofreturningaseque"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a>
Instead of returning a sequence of solutions, CONSTRUCT queries return
a graph. In the example below, we give an existing graph, in which triples
will be added. If we do not give a graph, a new (in memory) graph is returned.
We begin by creating a new graph which will receive the new triples,
then parse the CONSTRUCT query, then execute it. Then we show the resulting
graph.
</p>
<pre class="code-ocaml" id="letg2Rdf_graphopen_graph"><a class="paragraph-url" href="#letg2Rdf_graphopen_graph"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div><span class="hl kwa">let</span> g2 <span class="hl opt">=</span> <span class="hl kwc">Rdf_graph</span><span class="hl opt">.</span>open_graph base <span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> query <span class="hl opt">=</span> query_from_string
  <span class="hl str">&quot;PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;</span>
<span class="hl str">   CONSTRUCT { ?x foaf:name ?name ; foaf:mbox ?mbox . }</span>
<span class="hl str">   WHERE  { ?x foaf:name  ?name .</span>
<span class="hl str">       OPTIONAL { ?x foaf:mbox ?mbox } .</span>
<span class="hl str">       OPTIONAL { ?x foaf:homepage ?hpage }</span>
<span class="hl str">  }&quot;</span><span class="hl opt">;;</span></div><div>construct ~graph<span class="hl opt">:</span> g2 ~base dataset query<span class="hl opt">;;</span></div></pre>

<pre class="code-ocaml" id="prefixrdfhttpwwww3org199"><a class="paragraph-url" href="#prefixrdfhttpwwww3org199"><img alt="anchor" src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png"/></a><div class="ocaml-toplevel"></div><div class="ocaml-toplevel">@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
_:__b2__ &lt;http://xmlns.com/foaf/0.1/name&gt; &quot;Bob&quot; .
_:__b2__ &lt;http://xmlns.com/foaf/0.1/mbox&gt; &lt;mailto:bob@work.example&gt; .
_:__b1__ &lt;http://xmlns.com/foaf/0.1/name&gt; &quot;Alice&quot; .
</div></pre>

</div>





</div>

<footer id="bottombar">
</footer>
<script src="http://zoggy.github.io/ocaml-rdf/jquery.js" type="text/javascript">_</script>
<script src="http://zoggy.github.io/ocaml-rdf/bootstrap-collapse.js" type="text/javascript">_</script>

</body>
</html>