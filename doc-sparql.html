<!DOCTYPE HTML>
<html>
<head>
<title>OCaml-RDF : Executing Sparql queries</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" type="text/css" href="http://zoggy.github.io/ocaml-rdf/style.css"/>
<rssfeed></rssfeed>
</head><body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">

  <div class="nav-collapse">
  <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="http://zoggy.github.io/ocaml-rdf">OCaml-RDF</a></li>
    <li class="&lt;navbar-download/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/download.html">Download</a></li>
    <li class="active"><a href="http://zoggy.github.io/ocaml-rdf/doc.html">Documentation</a></li>
    <li class="&lt;navbar-blog/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="http://zoggy.github.io/ocaml-rdf/about.html">?</a></li>
  </ul>
  </div>
  <div class="nav pull-right">

  </div>
</div>
</div>
</div>

<div id="header">

<div class="page-title">Executing Sparql queries</div>
</div>
<span></span>



<p id="OCamlRDFimpl"><a class="paragraph-url" href="#OCamlRDFimpl"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
OCaml-RDF implements <span class="ext-a"><a href="http://www.w3.org/TR/sparql11-query/">Sparql 1.1 Query</a></span>.
<a href="http://zoggy.github.io/ocaml-rdf/doc-todo.html#limitations">Some features are missing</a> but it's already quite complete.
The main module of the implementation is 
<a href="refdoc/Rdf_sparql.html">Rdf_sparql</a>
. We consider
this module open in the examples below:
</p>
<pre id="openRdf_spar" class="code-ocaml"><a class="paragraph-url" href="#openRdf_spar"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div><span class="hl kwa">open</span> <span class="hl kwd">Rdf_sparql</span><span class="hl opt">;;</span></div></pre>
<ul class="toc"><li class="toc-section"><a href="#parsing">Parsing and printing queries</a></li><li class="toc-section"><a href="#dataset">Datasets</a></li><li class="toc-section"><a href="#execution">Executing a query</a></li><li class="toc-section"><a href="#construct">CONSTRUCT queries</a></li></ul>
<div class="section"><div class="section-title" id="parsing">Parsing and printing queries</div>
<p id="Theexamplebe"><a class="paragraph-url" href="#Theexamplebe"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
The example below parses a Sparql query, then prints it:
</p>
<pre id="letquerytryq" class="code-ocaml"><a class="paragraph-url" href="#letquerytryq"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div><span class="hl kwa">let</span> query <span class="hl opt">=</span>
  <span class="hl kwa">try</span> query_from_string
    <span class="hl str">&quot;PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;</span>
<span class="hl str">     SELECT ?name ?mbox ?hpage</span>
<span class="hl str">     WHERE  { ?x foaf:name  ?name .</span>
<span class="hl str">         OPTIONAL { ?x foaf:mbox ?mbox } .</span>
<span class="hl str">         OPTIONAL { ?x foaf:homepage ?hpage }</span>
<span class="hl str">       }&quot;</span>
  <span class="hl kwa">with</span> <span class="hl kwd">Error</span> e <span class="hl opt">-&gt;</span> failwith <span class="hl opt">(</span>string_of_error e<span class="hl opt">)</span>
<span class="hl opt">;;</span></div><div>print_endline <span class="hl opt">(</span>string_of_query query<span class="hl opt">);;</span></div></pre>
</div>

<div class="section"><div class="section-title" id="dataset">Datasets</div>
<p id="ASparqlquery"><a class="paragraph-url" href="#ASparqlquery"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
A Sparql query is executed on a
<span class="ext-a"><a href="http://www.w3.org/TR/sparql11-query/#rdfDataset"><em>dataset</em></a></span>,
which is composed of a default (unnamed) graph, and other (named) graphs each associated
to an IRI.
</p>
<p id="TheRdf_dsdat"><a class="paragraph-url" href="#TheRdf_dsdat"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>The 
<a href="refdoc/Rdf_ds.html#TYPEdataset">Rdf_ds.dataset</a>
 type represents a dataset and contains
a default graph (which can be empty), a set of graph names (i.e. a set of IRIs), and
a function to get a graph by its IRI.
</p>
<p id="Theexamplebel"><a class="paragraph-url" href="#Theexamplebel"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>The example below loads a graph from the file <code>optional.ttl</code> then
creates a dataset with this graph as default graph, and no named graphs:
</p>
<pre id="letbaseRdf_i" class="code-ocaml"><a class="paragraph-url" href="#letbaseRdf_i"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div><span class="hl kwa">let</span> base <span class="hl opt">=</span> <span class="hl kwc">Rdf_iri</span><span class="hl opt">.</span>iri <span class="hl str">&quot;http://foo.net&quot;</span><span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> g <span class="hl opt">=</span> <span class="hl kwc">Rdf_graph</span><span class="hl opt">.</span>open_graph base <span class="hl opt">;;</span></div><div><span class="hl kwc">Rdf_ttl</span><span class="hl opt">.</span>from_file g <span class="hl str">&quot;optional.ttl&quot;</span><span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> dataset <span class="hl opt">=</span> <span class="hl kwc">Rdf_ds</span><span class="hl opt">.</span>simple_dataset g <span class="hl opt">;;</span></div></pre>
<p id="Hereisthecon"><a class="paragraph-url" href="#Hereisthecon"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>Here is the content of our graph:</p>

<pre id="prefixfoafht" class="code-ocaml"><a class="paragraph-url" href="#prefixfoafht"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div class="ocaml-toplevel"></div><div class="ocaml-toplevel">@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
_:genid1-982876160 foaf:name &quot;Bob&quot; .
_:genid1-982876160 foaf:mbox &lt;mailto:bob@work.example&gt; .
_:genid0-850776007 foaf:name &quot;Alice&quot; .
_:genid0-850776007 foaf:homepage &lt;http://work.example.org/alice/&gt; .
</div></pre>

</div>

<div class="section"><div class="section-title" id="execution">Executing a query</div>
<p id="Thefollowing"><a class="paragraph-url" href="#Thefollowing"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
The following code executes the query parsed above, on the dataset
defined in previous section. Since this is a SELECT query, the

<a href="refdoc/Rdf_sparql.html#VALexecute">Rdf_sparql.execute</a>
  function returns a <code>Solutions</code>
constructor with the sequence of solutions.
</p>
<pre id="letresexecut" class="code-ocaml"><a class="paragraph-url" href="#letresexecut"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div># <span class="hl kwa">let</span> res <span class="hl opt">=</span> execute ~base dataset query<span class="hl opt">;;</span></div><div class="ocaml-toplevel">val res : Rdf_sparql.query_result = Solutions [&lt;abstr&gt;; &lt;abstr&gt;]</div></pre>
<p id="Sinceweknowt"><a class="paragraph-url" href="#Sinceweknowt"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
Since we know that our query is a SELECT, we can use a convenient function
which will ensure that the query is a SELECT and return directly the sequence
of solutions:
</p>
<pre id="letsolutions" class="code-ocaml"><a class="paragraph-url" href="#letsolutions"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div># <span class="hl kwa">let</span> solutions <span class="hl opt">=</span> select ~base dataset query <span class="hl opt">;;</span></div><div class="ocaml-toplevel">val solutions : Rdf_sparql.solution list = [&lt;abstr&gt;; &lt;abstr&gt;]</div></pre>
<p id="Letsdisplayt"><a class="paragraph-url" href="#Letsdisplayt"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
Let's display the result. A solution, of type 
<a href="refdoc/Rdf_sparql.html#TYPEsolution">Rdf_sparql.solution</a>
,
is a map from variable name (string) to 
<a href="refdoc/Rdf_term.html#TYPEterm">Rdf_term.term</a>
.
Let's print the solutions we obtained.
</p>
<pre id="letprint_sol" class="code-ocaml"><a class="paragraph-url" href="#letprint_sol"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div># <span class="hl kwa">let</span> print_sol <span class="hl opt">=</span>
  <span class="hl kwa">let</span> print varname term <span class="hl opt">=</span>
     <span class="hl kwc">Printf</span><span class="hl opt">.</span>printf <span class="hl str">&quot;%s =&gt; %s</span><span class="hl esc">\n</span><span class="hl str">&quot;</span> varname <span class="hl opt">(</span><span class="hl kwc">Rdf_term</span><span class="hl opt">.</span>string_of_term term<span class="hl opt">)</span>
  <span class="hl kwa">in</span>
  <span class="hl kwa">fun</span> sol <span class="hl opt">-&gt;</span>
    print_endline <span class="hl str">&quot;Solution:&quot;</span><span class="hl opt">;</span>
    solution_iter print sol <span class="hl opt">;</span>
    print_newline<span class="hl opt">();;</span></div><div class="ocaml-toplevel">val print_sol : Rdf_sparql.solution -&gt; unit = &lt;fun&gt;</div><div># <span class="hl kwc">List</span><span class="hl opt">.</span>iter print_sol solutions<span class="hl opt">;;</span></div><div class="ocaml-toplevel">Solution:
hpage =&gt; &lt;http://work.example.org/alice/&gt;
name =&gt; &quot;Alice&quot;

Solution:
mbox =&gt; &lt;mailto:bob@work.example&gt;
name =&gt; &quot;Bob&quot;

- : unit = ()</div></pre>
</div>

<div class="section"><div class="section-title" id="construct">CONSTRUCT queries</div>
<p id="Insteadofret"><a class="paragraph-url" href="#Insteadofret"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a>
Instead of returning a sequence of solutions, CONSTRUCT queries return
a graph. In the example below, we give an existing graph, in which triples
will be added. If we do not give a graph, a new (in memory) graph is returned.
We begin by creating a new graph which will receive the new triples,
then parse the CONSTRUCT query, then execute it. Then we show the resulting
graph.
</p>
<pre id="letg2Rdf_gra" class="code-ocaml"><a class="paragraph-url" href="#letg2Rdf_gra"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div><span class="hl kwa">let</span> g2 <span class="hl opt">=</span> <span class="hl kwc">Rdf_graph</span><span class="hl opt">.</span>open_graph base <span class="hl opt">;;</span></div><div><span class="hl kwa">let</span> query <span class="hl opt">=</span> query_from_string
  <span class="hl str">&quot;PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;</span>
<span class="hl str">   CONSTRUCT { ?x foaf:name ?name ; foaf:mbox ?mbox . }</span>
<span class="hl str">   WHERE  { ?x foaf:name  ?name .</span>
<span class="hl str">       OPTIONAL { ?x foaf:mbox ?mbox } .</span>
<span class="hl str">       OPTIONAL { ?x foaf:homepage ?hpage }</span>
<span class="hl str">  }&quot;</span><span class="hl opt">;;</span></div><div>construct ~graph<span class="hl opt">:</span> g2 ~base dataset query<span class="hl opt">;;</span></div></pre>

<pre id="prefixrdfhtt" class="code-ocaml"><a class="paragraph-url" href="#prefixrdfhtt"><img src="http://zoggy.github.io/ocaml-rdf/paragraph-url.png" alt="anchor"/></a><div class="ocaml-toplevel"></div><div class="ocaml-toplevel">@prefix rdf: &lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt; .
_:__b2__ &lt;http://xmlns.com/foaf/0.1/name&gt; &quot;Bob&quot; .
_:__b2__ &lt;http://xmlns.com/foaf/0.1/mbox&gt; &lt;mailto:bob@work.example&gt; .
_:__b1__ &lt;http://xmlns.com/foaf/0.1/name&gt; &quot;Alice&quot; .
</div></pre>

</div>





</div>

<footer id="bottombar">
</footer>
<script type="text/javascript" src="http://zoggy.github.io/ocaml-rdf/jquery.js">_</script>
<script type="text/javascript" src="http://zoggy.github.io/ocaml-rdf/bootstrap-collapse.js">_</script>

</body>
</html>